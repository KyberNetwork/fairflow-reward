name: Sync Notion Merkle files (weekly)

on:
  push:
    branches:
      - "**"
  schedule:
    # Friday 15:00 GMT+7 (08:00 UTC).
    - cron: "0 8 * * 5"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }}
      GH_PAT: ${{ secrets.GH_PAT }}
      GH_USER: kyber-ci-bot
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

    steps:
      - name: Checkout fairflow-reward
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Configure git identity
        run: |
          git config user.name "kyber-ci-bot"
          git config user.email "kyber-ci-bot@users.noreply.github.com"

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.x"

      - name: Enable git auth for GH CLI
        run: gh auth setup-git

      - name: Compute next cycle from folders
        id: cycle
        run: |
          set -euo pipefail
          max=0
          for d in cycle-*; do
            [ -d "$d" ] || continue
            n="${d#cycle-}"
            if [[ "$n" =~ ^[0-9]+$ ]] && [ "$n" -gt "$max" ]; then max="$n"; fi
          done
          next=$((max+1))
          echo "next_cycle=$next" >> "$GITHUB_OUTPUT"
          echo "Next cycle: $next"

      - name: Download Cycle files from Notion
        run: |
          set -euo pipefail
          go run ./cmd/notion-sync \
            --database-id "$NOTION_DATABASE_ID" \
            --cycle "${{ steps.cycle.outputs.next_cycle }}" \
            --out-dir "." \
            --mapping "config/notion_mappings.json" \
            --allow-existing \
            --prop-title "Task name" \
            --prop-status "Status" \
            --prop-chain "Chain" \
            --prop-type "Type" \
            --prop-file "Merkle file" \
            --status-done "Done"

      - name: Create or update PR in fairflow-reward
        id: pr_fairflow
        run: |
          set -euo pipefail
          if git status --porcelain | grep -q .; then
            branch="bot/cycle-${{ steps.cycle.outputs.next_cycle }}"
            git fetch origin "$branch" || true
            git checkout -B "$branch"
            git add -A
            git commit -m "Add merkle files for cycle ${{ steps.cycle.outputs.next_cycle }}"
            git push -u origin "$branch" --force

            if gh pr view --repo KyberNetwork/fairflow-reward --head "KyberNetwork:$branch" >/dev/null 2>&1; then
              echo "PR already exists for $branch."
            else
              gh pr create \
                --repo KyberNetwork/fairflow-reward \
                --title "Cycle ${{ steps.cycle.outputs.next_cycle }} merkle files" \
                --body "Automated sync from Notion.\n\nNext: merge this PR before merging kyber-applications PR (raw URLs must exist on main)." \
                --base main \
                --head "$branch"
            fi
          else
            echo "No changes; nothing to PR."
          fi

      - name: Clone kyber-applications
        run: |
          set -euo pipefail
          rm -rf /tmp/kyber-applications
          gh repo clone KyberNetwork/kyber-applications /tmp/kyber-applications
          cd /tmp/kyber-applications
          git config user.name "kyber-ci-bot"
          git config user.email "kyber-ci-bot@users.noreply.github.com"

      - name: Update kyber-applications values.yaml (URL replace only)
        run: |
          set -euo pipefail
          cycle="${{ steps.cycle.outputs.next_cycle }}"
          dir="cycle-$cycle"
          if [ ! -d "$dir" ]; then
            echo "Cycle directory not found at $dir (likely no downloads). Skipping kyber-applications PR."
            exit 0
          fi

          go run ./cmd/update-kyber-applications \
            --values "/tmp/kyber-applications/core/reward-service/api/public/values.yaml" \
            --cycle-dir "$GITHUB_WORKSPACE/$dir" \
            --raw-prefix "https://raw.githubusercontent.com/KyberNetwork/fairflow-reward/refs/heads/main"

      - name: Create or update PR in kyber-applications
        run: |
          set -euo pipefail
          cd /tmp/kyber-applications
          if git status --porcelain | grep -q .; then
            branch="bot/new-cycle-${{ steps.cycle.outputs.next_cycle }}"
            git fetch origin "$branch" || true
            git checkout -B "$branch"
            git add -A
            git commit -m "Update KEM DistributorCampaigns for cycle ${{ steps.cycle.outputs.next_cycle }}"
            git push -u origin "$branch" --force

            if gh pr view --repo KyberNetwork/kyber-applications --head "KyberNetwork:$branch" >/dev/null 2>&1; then
              echo "PR already exists for $branch."
            else
              gh pr create \
                --repo KyberNetwork/kyber-applications \
                --title "KEM: add cycle ${{ steps.cycle.outputs.next_cycle }} URLs" \
                --body "Updates core/reward-service/api/public/values.yaml by URL string replacement only.\n\nWARNING: Merge fairflow-reward PR first, otherwise raw URLs may 404." \
                --base main \
                --head "$branch"
            fi
          else
            echo "No kyber-applications changes; nothing to PR."
          fi
